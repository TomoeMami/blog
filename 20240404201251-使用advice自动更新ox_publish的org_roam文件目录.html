<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-04-06 周六 10:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>使用advice自动更新ox-publish的待发布org-roam文件目录</title>
<meta name="generator" content="Org Mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
@import url("https://fonts.googleapis.com/css2?family=Lora:wght@500&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Inconsolata&display=swap");

body {
    margin: 10px auto;
    width: 900px;
    max-width: 100%;
    background: white;
    font-size: 18px;
}

#preamble {
    width: 80%;
    max-width: 980px;
    text-align: right;
    margin: auto;
}

hr {
    border: none;
    border-top: 5px double #333;
    margin: 0px 0;
}

.button {
    border: none;
    color: black;
    padding: 6px 14px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    margin: 4px 2px;
    transition-duration: 0.4s;
    cursor: pointer;
}

.button:hover {
    background-color: #3a1616;
    color: white;
}

#content, .content {
    width: 80%;
    max-width: 980px;
    margin: auto;
}

#org-div-home-and-up{
    position: fixed;
    right: 0.5em;
    margin-top: 70px;
    font-family:sans-serif;
}

#table-of-contents {
    margin-top: 105px;
    font-size: 12pt;
    position: fixed;
    left: 0em;
    top: 0em;
    background: white;
    max-height: 80%;
    overflow: auto;
}

#table-of-contents h2 {
    display: none;
}
#table-of-contents li {
    clear: both;
}
.timestamp {
    color: #bebebe;
    font-size: $smaller;
}

.timestamp-kwd {
    color: #5f9ea0;
}

@media screen and (max-width: 1200px) {
    #table-of-contents {
        position: relative;
        margin-top: 0px;
    }
}

p:not(blockquote > p) :not(ol > p) {
    text-indent: 2em;
}

.title {
    font-size: 30px;
    line-height: 1.3;
    font-weight: bold;
    color: #0c2340;
}

h2:not(#table-of-contents > h2) {
    font-size: 30px;
    line-height: 1.2;
    position: relative;
    color: #204060;
}

h2::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    background-color: black;
}

h3:not(#table-of-contents > h3) {
    font-size: 20px;
    line-height: 1.1;
    position: relative;
    color: #4b748d;
}

h3::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    border-bottom: 1px dashed black;
}

h4 {
    font-size: 14px;
    line-height: 1.1;
    font-weight: bold;
}


a {
    cursor: pointer;
    text-decoration: none;
}

a:link {
    color: #458588;
    /* text-decoration: underline; */
}

a:hover {
    /* font-weight: bold; */
    text-decoration: underline;
    /* color: #076678; */
}

.figure {
    text-align: center;
}

a:visited{
    color: #8f3f71;
    /* text-decoration: underline; */
}

img {
  width: 600px;
}

@media screen and (max-width: 1200px) {
    img {
        width: 400px;
    }
}

.org-src-container {
    font-size: 14px;
    outline: 2px dashed #ccc;
    outline-offset: 10px;
    position: relative;
    
}
.org-src-container>pre {
    overflow: auto;
}

.org-src-container>pre:before {
    display: block;
    position: absolute;
    background-color: #b3b3b3;
    top: 0;
    right: 0;
    padding: 0 0.5em;
    border-bottom-left-radius: 8px;
    border: 0;
    color: white;
    font-size: $code-size;
}
/* .org-src-container::before { */
/*     content: "Copy"; */
/*     position: absolute; */
/*     top: 5px; */
/*     right: 5px; */
/*     padding: 5px; */
/*     background-color: #ccc; */
/*     color: #fff; */
/*     border-radius: 3px; */
/*     cursor: pointer; */
/* } */

code {
    font-size: 16px;
    color: #4F894C;
}

.subtitle {
    text-align: right;
}

blockquote {
    border-left: 3px solid #ccc;
    padding-left: 10px; /* Optional: add some left padding for the content */
}

.info {
    overflow: hidden;
}

.created {
    float: right;
}

.updated {
    float: left;
}

.org-ol {
    list-style-type: decimal; /* Set the list style type to decimal numbers */
    margin-left: 1.5em; /* Add left margin to the list */
}

b {
    color: red;
}

#footnotes {
    position: fixed;
    left: auto;
    right: 0;
    top: 105px;
    bottom: 0;
    width: 20%;
    padding: 10px;
    overflow: auto;
    font-size: 14px;
    z-index: 9999;
}

#footnotes h2 {
    display: none;
}

@media screen and (max-width: 1200px) {
    #footnotes {
        position: static;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-height: 30%;
        overflow: auto;
        padding: 10px;
        font-size: 14px;
        z-index: 9999;
    }
}
/*]]>*/-->
 </style>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">使用advice自动更新ox-publish的待发布org-roam文件目录</h1>
<p>
最近在研究用Emacs写博客。由于并不在意博客样式，因此选择用ox-publish直接将指定的org-roam文件导出为html再上传GitHub通过GitHub Pages托管。<br />
</p>

<p>
参考文献：<br />
<a href="https://zhuanlan.zhihu.com/p/634873048">Emacs: 使用 org publish 生成个人博客</a><br />
<a href="https://zhuanlan.zhihu.com/p/601052964">26.ox-html 浅析与 ox-publish 使用介绍</a><br />
</p>

<p>
由于org-roam的所有文件均在一个文件夹内，又不需要将所有的文件作为博客内容发表，因此接下来会利用org-roam的功能，动态发布打上了 <code>blog</code> 标签的文件。<br />
</p>

<div id="outline-container-org63eb58f" class="outline-2">
<h2 id="org63eb58f"><span class="section-number-2">1.</span> 获取带 <code>blog</code> 标签的文件</h2>
<div class="outline-text-2" id="text-1">
<p>
参考<a href="https://d12frosted.io/posts/2021-01-16-task-management-with-roam-vol5.html">Vulpea的org-roam动态agenda</a>文件，创建函数如下：<br />
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun my/ox-files ()
  "Return a list of note files containing 'blog' tag." ;
  (seq-uniq
   (seq-map
    #'car
    (org-roam-db-query
     [:select [nodes:file]
              :from tags
              :left-join nodes
              :on (= tags:node-id nodes:id)
              :where (like tag (quote "%\"blog\"%"))]))))
</pre>
</div>

<p>
上述函数可以返回org-roam-db中标有“blog”的文件路径列表。<br />
</p>
</div>
</div>

<div id="outline-container-org1423ba8" class="outline-2">
<h2 id="org1423ba8"><span class="section-number-2">2.</span> 配置ox-publish</h2>
<div class="outline-text-2" id="text-2">
<p>
根据参考文献，需要指定 <code>org-publish-project-alist</code> 如下：<br />
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq org-publish-project-alist
        `(("posts"
           :base-directory ,website-directory
           :base-extension "org"
           :publishing-directory ,my/publish-directory
           :publishing-function org-html-publish-to-html
           :with-author t
           :auto-sitemap t
           :recursive nil
           :exclude ".*"
           :include ,(my/ox-files)
           :html-link-home "index.html"
           :sitemap-filename "index.org"
           :sitemap-title "目录"
           :sitemap-sort-files anti-chronologically
           :html-head:css "&lt;link rel='stylesheet' type='text/css' href='/org.css'/&gt;")
          ("personal-website" :components ("posts"))))
</pre>
</div>

<p>
上图代码通过 <code>:exclude ".*"</code> 排除所有文件，然后通过 <code>:include ,(my/ox-files)</code> 将带有blog标签的org-roam文件路径纳入ox-publish的处理范畴中<br />
</p>
</div>
</div>

<div id="outline-container-orgc1b1b2d" class="outline-2">
<h2 id="orgc1b1b2d"><span class="section-number-2">3.</span> 动态更新待发布文件列表</h2>
<div class="outline-text-2" id="text-3">
<p>
由于上述 <code>org-publish-project-alist</code> 仅会执行单次，因此需要通过 <code>advice-add</code> 的方式让其在每次发布时均执行一次，达成动态更新的效果。<br />
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun my/org-project-update (&amp;optional ARG PRED) ;;使用before会接收到原函数参数，因此需要添加optional
  (setq org-publish-project-alist
        `(("posts"
           :base-directory ,website-directory
           :base-extension "org"
           :publishing-directory ,my/publish-directory
           :publishing-function org-html-publish-to-html
           :with-author t
           :auto-sitemap t
           :recursive nil
           :exclude ".*"
           :include ,(my/ox-files)
           :html-link-home "index.html"
           :sitemap-filename "index.org"
           :sitemap-title "目录"
           :sitemap-sort-files anti-chronologically
           :html-head:css "&lt;link rel='stylesheet' type='text/css' href='/org.css'/&gt;")
          ("personal-website" :components ("posts")))))
(advice-add 'org-publish-projects :before 'my/org-project-update)
</pre>
</div>

<p>
这样，每次 <code>org-publish-projects</code> 函数运行前，均会更新待发布文件路径。注意这个方法对函数 <code>org-publish-file</code> 无效，所以仅适用于发布整个project的情况。<br />
</p>
</div>
</div>

<div id="outline-container-org79b1ff4" class="outline-2">
<h2 id="org79b1ff4"><span class="section-number-2">4.</span> 为每个html文件插入CSS</h2>
<div class="outline-text-2" id="text-4">
<p>
利用org-export的hook自动设置，读取 <code>~/.emacs.d/org.css</code> 文件内容并插入发布的html文件中<br />
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun my/org-inline-css-hook (exporter)
  "Insert custom inline css"
  (when (eq exporter 'html)
    (setq org-html-head-include-default-style nil)
    (setq org-html-head (concat "&lt;style type=\"text/css\"&gt;\n &lt;!--/*--&gt;&lt;![CDATA[/*&gt;&lt;!--*/\n" (with-temp-buffer (insert-file-contents "~/.emacs.d/org.css") (buffer-string)) "/*]]&gt;*/--&gt;\n &lt;/style&gt;\n"))
    ;; (setq org-html-head "&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://gongzhitaao.org/orgcss/org.css\"/&gt;")
    ))

(add-hook 'org-export-before-processing-hook 'my/org-inline-css-hook)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge0851ac" class="outline-2">
<h2 id="orge0851ac"><span class="section-number-2">5.</span> 一些其他的小设置</h2>
<div class="outline-text-2" id="text-5">
<p>
导出时单换行也视为换行<br />
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq org-export-preserve-breaks t)
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2024-04-06 周六 10:12</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
